/*
 * -------------------------------------------------------------------------------
 * "THE BEER-WARE LICENSE":
 * This code, and some of the associated files where written and put together
 * by @foag (Daniel Modig), daniel@ikoncept.se in 2014. If you like this code
 * and find it useful, feel free to use it any way you seem fit as long as this
 * notice is intact. I'm not to be held responsible for anything related to the 
 * usage of this code, and should we meet someday and you think the code is worth 
 * it to you, feel free to buy me a beer :) If you're on a budget a hug is good 
 * enough.
 * -------------------------------------------------------------------------------
 */
var countries_url="data/countries.json",maps_url="data/countries/#.geo.json",flag_url="data/countries/#.svg",stamenLayer=L.tileLayer("https://stamen-tiles-{s}.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.png",{attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>.'}),bordersWMS=L.tileLayer.wms("http://www.opengis.uab.cat/cgi-bin/world/MiraMon.cgi?",{layers:"admin_level0-world",format:"png",transparent:!0}),group=new L.featureGroup,blimp={active:!1,answer:{bind:function(){$("body").on("submit",".answer-form",function(a){a.preventDefault(),$(".big-skip").addClass("hidden"),blimp.answer.is_match($("#answer-input").val())}),$("body").on("click",".big-correct",function(a){a.preventDefault(),blimp.reset()})},is_match:function(a){isMatch=!1,a=a.toLowerCase(),results=blimp.country.prox.get(a),results&&$.each(results,function(a,b){b[0]>.7&&(isMatch=!0)}),isMatch?(blimp.scoring.set(),blimp.data.used.push(blimp.country.current),blimp.save(),blimp.country.layer.setStyle(map_style.success),$(".support-text").html('<h3 class="success">'+blimp.data.random(blimp.data.dictionary.correct_answer)+"</h3>"),$(".big-correct,.answer-form").toggleClass("hidden"),$(".hints a").click(),$(".big-correct").focus()):$(".support-text").html('<h3 class="fail">'+blimp.data.random(blimp.data.dictionary.wrong_answer)+"</h3>")}},country:{layer:null,current:null,names:null,get:function(a){a=a||!1;var b=null;if(a){var c=blimp.data.countries;for(var d in c)c[d].cca3==a&&(b=c[d])}else for(b=blimp.data.random(blimp.data.countries);blimp.data.used_short().indexOf(b.cca3)>-1;)b=blimp.data.random(blimp.data.countries);return a?b:(blimp.country.current=b,blimp.country.geo(b.cca3),blimp.country.get_names(),void 0)},geo:function(a){var b=maps_url.replace("#",a);blimp.load(b,function(a){blimp.country.current.geo=a,blimp.country.plot_to_map()},blimp.country.get)},plot_to_map:function(){try{blimp.country.layer=L.geoJson(blimp.country.current.geo,{style:map_style.highlight}),map.addLayer(blimp.country.layer),map.fitBounds(blimp.country.layer.getBounds()),blimp.loading(!1)}catch(b){blimp.start()}},get_names:function(){var a=blimp.country.current,b=[];$.each(_i.flatten(a.name),function(a,c){b.push(c.toLowerCase())}),$.each(_i.flatten(a.translations),function(a,c){b.push(c.toLowerCase())}),blimp.country.current.names=b,blimp.country.prox=FuzzySet(b)}},data:{countries:null,used:[],dictionary:{adjectives:["adaptable","adventurous","affable","affectionate","agreeable","ambitious","amiable","amicable","amusing","brave","bright","broad-minded","calm","careful","charming","communicative","compassionate","conscientious","considerate","convivial","courageous","courteous","creative","decisive","determined","diligent","diplomatic","discreet","dynamic","easygoing","emotional","energetic","enthusiastic","exuberant","fair-minded","faithful","fearless","forceful","frank","friendly","funny","generous","gentle","good","gregarious","hard-working","helpful","honest","humorous","imaginative","impartial","independent","intellectual","intelligent","intuitive","inventive","kind","loving","loyal","modest","neat","nice","optimistic","passionate","patient","persistent","pioneering","philosophical","placid","plucky","polite","powerful","practical","pro-active","quick-witted","quiet","rational","reliable","reserved","resourceful","romantic","self-confident","self-disciplined","sensible","sensitive","shy","sincere","sociable","straightforward","sympathetic","thoughtful","tidy","tough","unassuming","understanding","versatile","warmhearted","willing","witty"],adjectives_heroic:["bold","courageous","dauntless","doughty","fearless","gallant","greathearted","gutsy","gutty","brave","heroical","intrepid","lionhearted","manful","stalwart","stout","stouthearted","undaunted","valiant","valorous"],verb_live:["resides","abides","dwells","lives"],wrong_answer:["Sorry, I meant the REAL name..","Really, you think THAT's the name?","HAHA. No.","Say what?","Did you ever go to school?","My dog knows the right answer, why don't you?","Have you met Mr. Wrong?","For realz?","That's ridiculous","Are you even trying?"],correct_answer:["Yay!","Correctamundo!","Right you are, my dear Watson!","How did you.. Wait a minute.. Alright, have your points..","Spot on!","Are you cheating?","For realz!","Indeed it is!","You're right!","Much right, very success!"]},random:function(a,b,c){if(b=b||1,c=c||[],c=c instanceof Array?c:[c],a.length>c.length){var d=[];for(i=0;b>i;i++){for(var e=a[Math.floor(Math.random()*a.length)];c.indexOf(e)>-1&&d.indexOf(e)>-1;)e=a[Math.floor(Math.random()*a.length)];d.push(e)}return 1==d.length?d[0]:d}return!1},used_short:function(){var a=[];return $.each(this.used,function(b,c){a.push(c.cca3)}),a},hint_model:null,set_used:function(a){$.each(a,function(a,b){console.log(b),c=blimp.country.get(b),blimp.data.used.push(c),L.geoJson(blimp.country.current.geo,{style:map_style.highlight}),map.addLayer(blimp.country.layer)})}},hints:{bind:function(){$("body").on("click",".hints a",function(a){return blimp.scoring.set_current($(a.currentTarget).attr("data-value")),$(a.currentTarget).parent().addClass("hint-used"),blimp.hints.fn[$(a.currentTarget).attr("data-fn")](a),$(".big-skip").addClass("hidden"),$(".points-text").text($(a.currentTarget).attr("data-text")),!1})},fn:{show_flag:function(a){$(a.currentTarget).parent().html('<img class="flag" src="'+flag_url.replace("#",blimp.country.current.cca3)+'">')},show_capital:function(a){$(a.currentTarget).parent().html("The capital is <strong>"+blimp.country.current.capital+"</strong>.")},show_options:function(a){var b='This country borders to:<ul class="list-unstyled">';if(blimp.country.current.borders.length>0)$.each(blimp.country.current.borders,function(a,c){var d=blimp.country.get(c);b+="<li><strong>"+d.name.common+"</strong></li>"});else var b="This country is sadly forever alone :(.<br> It has the awesome TLD <strong><em>"+blimp.country.current.tld+"</strong></em>.";$(a.currentTarget).parent().html(b)},show_all:function(a){var b,c,d="";b=blimp.data.random(blimp.data.dictionary.adjectives),c=blimp.data.random(blimp.data.dictionary.adjectives_heroic,3),$.each(blimp.country.current.translations,function(a,b){d+=b+", "}),d=d.replace(/,\s*$/,"");var e='<h2><span class="thin">This of course, is the '+b+" country of</span> "+blimp.country.current.name.common+' <span class="thin">where the '+c[0]+", "+c[1]+" and "+c[2]+" "+blimp.country.current.demonym+"s "+blimp.data.random(blimp.data.dictionary.verb_live)+"!<br><br><small>When traveling, you might hear other names, such as <code>"+d+"</code></small>";$(a.currentTarget).parent().html(e)}}},init:function(){blimp.hints.bind(),blimp.answer.bind(),blimp.nav(),blimp.data.hint_model=$(".hint-list").html(),blimp.load(countries_url,function(a){blimp.loading("Wow, such data crunch"),blimp.data.countries=a,blimp.poll()})},loading:function(a){a===!1?$(".loading").fadeOut(100):($(".loading h2 span").text(a),$(".loading").fadeIn(100))},load:function(a,b,c){c=c||function(a,b){console.log("error "+b)},$.getJSON(a,function(){}).success(b).error(c)},load_saved:{has:function(){return simpleStorage.canUse()?data=simpleStorage.get("blimp"):void 0},load:function(){simpleStorage.canUse()&&(data=simpleStorage.get("blimp"),blimp.scoring.load(data.score),blimp.data.used=data.used,$.each(blimp.data.used,function(a,b){var c=L.geoJson(b.geo,{style:map_style.success});map.addLayer(c)}),blimp.start())}},nav:function(){$(".about a").click(function(a){a.preventDefault(),$(".question,.info").toggleClass("hidden"),$(this).toggleClass("active")}),$(".re-center").click(function(a){a.preventDefault(),map.fitBounds(blimp.country.layer.getBounds())}),$(".big-skip").click(function(a){a.preventDefault(),map.removeLayer(blimp.country.layer),blimp.start()}),$(".load-no").click(function(a){a.preventDefault(),simpleStorage.flush(),blimp.start(),blimp.loading(!1)}),$(".reload").click(function(a){a.preventDefault(),simpleStorage.flush(),window.location.reload()}),$(".load-yes").click(function(a){a.preventDefault(),blimp.load_saved.load()})},poll:function(){var a=blimp.load_saved.has();void 0===a?(blimp.start(),blimp.loading(!1)):$(".loading h2, .loading .big-load").toggleClass("hidden")},reset:function(){$(".answer-form").trigger("reset"),$(".big-correct,.answer-form").toggleClass("hidden"),$(".support-text").html(""),$(".points-text").html("a full 10"),$(".hint-list").html(blimp.data.hint_model),$(".big-skip").removeClass("hidden"),blimp.scoring.current=10,blimp.start()},save:function(){if(simpleStorage.canUse()){var a={score:[blimp.scoring.total,blimp.scoring.questions],used:blimp.data.used};simpleStorage.set("blimp",a)}},scoring:{total:0,max:0,current:10,ratio:0,questions:0,set_current:function(a){this.current>parseInt(a)&&(this.current=parseInt(a))},load:function(a){this.total=a[0],this.questions=a[1],this.max=10*this.questions,$(".points-ratio").text(this.total),$(".points-total").text(this.total),$(".points-max").text(this.max)},set:function(){this.questions+=1,this.max=10*this.questions,this.total=this.total+this.current,$(".points-ratio").text(this.total),$(".points-total").text(this.total),$(".points-max").text(this.max)}},start:function(){blimp.data.used.length<blimp.data.countries.length-5?(this.country.get(),$("#answer-input").focus()):$(".congrats").toggleClass("hidden")}},filter={region:function(){var a=[];$.each(blimp.data.countries,function(b,c){-1==a.indexOf(c.region)&&a.push(c.region)}),console.log(a)},sub_region:function(){var a=[];$.each(blimp.data.countries,function(b,c){-1==a.indexOf(c.subregion)&&a.push(c.subregion)}),console.log(a)}},map=L.map("map",{}).addLayer(stamenLayer).addLayer(bordersWMS).on("load",function(){blimp.init()}).setView([0,0],1),map_style={"default":{color:"#ff7800",weight:1,opacity:.65},highlight:{color:"#FF3300",weight:1,opacity:.9},success:{color:"#00ff00",weight:1,opacity:.65},fail:{color:"#ff0000",weight:1,opacity:.65}};_i={flatten:function(a){var d,b=arguments[1]||"",c=arguments[2]||{};for(d in a)a.hasOwnProperty(d)&&("object"==typeof a[d]?_i.flatten(a[d],b+d+".",c):c[b+d]=a[d]);return c}};
